---
title: "[C++] Thread"
excerpt: "Thread"

categories:
- C++
tags:
- [C++]

toc: true
toc_sticky: true

date: 2022-06-18
last_modified_at: 2022-06-18
---
# Thread

## 프로세스와 쓰레드(Process & Thread)

### 프로세스(Process)

프로세스란, 운영체제에서 실행되는 프로그램의 최소 단위이다. 우리가 1개의 프로그램을 가리킬 때 보통 1개의 프로세스를 의미하며,  프로세스는 CPU의 코어에서 실행된다.

**CPU는 한 번에 한 개의 연산을 수행**하는데 우리는 인터넷을 하면서 음악을 듣고, 게임을 하는 등 여러가지 일들을 동시에 할 수 있다. 이는 **컨텍스트 스위칭(Context Switching)** 이라는 기술 덕분이다.

#### 컨텍스트 스위칭(Context Switching)

컴퓨터에서 프로그램이 실행될 때 겉으로 보기에는 프로그램이 연속적으로 쭈욱 작동하는 것 처럼 보이지만 실제로는 **프로그램 하나가 잠시 실행되었다가, 다른 프로그램으로 스위칭한다.**

![cpu_contextswitching](https://user-images.githubusercontent.com/57252713/174427077-eec3facf-80c2-4c3d-a159-44f4a503d103.png)

정확히는, CPU는 운영체제에게 처리하라고 시키는 명령어들을 실행할 뿐, 어떤 프로그램을 실행시키고, 얼마동안 실행시키고, 다음에 무슨 프로그램으로 스위칭 할지는 **운영체제의 스케줄러**가 결정한다.



### 쓰레드(Thread)

CPU 코어에서 돌아가는 프로그램 단위를 **쓰레드(Thread)**라고 한다. CPU의 코어 하나에서는 **한 번에 한 개의 쓰레드의 명령을 실행**시키게 된다.

한 개의 프로세스는 최소 한 개의 쓰레드로 이루어져 있으며, 여러 개의 쓰레드로 구성될 수 있다. 이렇게 여러 개의 쓰레드로 구성된 프로그램을 **멀티 쓰레드(Multi Thread)** 프로그램이라고 한다.

**쓰레드와 프로세스의 가장 큰 차이점**은 프로세스들은 **서로 메모리를 공유하지 않는** 반면에, 쓰레드는 **서로 같은 메모리를 공유**하는 점이다.



> 현대의 CPU는 여러 개의 코어를 지원 즉, 멀티 코어 CPU에서 여러 개의 코어에 각기 다른 쓰레드들이 들어가 동시에 여러 개의 쓰레드들을 효율적으로 실행할 수 있다.



## 멀티 쓰레드(Multi Thread)

그럼 어떤 상황일 때 프로그램을 멀티 쓰레드로 만드는 것이 유리할까?

### 병렬 가능한 (Parallelizable) 작업들

예를 들어 1부터 10000까지 더하는 작업을 구현한다고 가정해본다. 만약에 단일 쓰레드 프로그램으로 구현한다면 `for`문으로 1부터 10000까지 더하는 코드를 작성하면 된다.

반면에 이를 쓰레드 10개로 만든다면, 쓰레드1이 1부터 1000까지 더하고, 쓰레드2가 1001부터 2000까지 ... 쓰레드 10에서 9001 부터 10000까지 더한 뒤에 모든 쓰레드 작업 완료 후에 각각의 결과를 합치는 식으로 구현할 수 있다.

```cpp
// 단일 쓰레드로 구현한 1 ~ 10000 더하기
for (int i = 1; i <= 10000; ++i)
{
    sum += i;
}

// 멀티 쓰레드로 구현한 1 ~ 10000 더하기 (쓰레드 10개)

// Thread #1
for (int i = 1; i <= 1000; ++i)
{
    sum[0] += i;
}

// Thread #2
for (int i = 1001; i <= 2000; ++i)
{
    sum[1] += i;
}

...
    
// 모든 쓰레드 실행 후
for (int i = 0; i <= 10; ++i)
{
    sum += sum[i];
}
```

CPU 코어에서 덧셈 한 번에 1초가 걸린다고 했을 때, 단일 쓰레드의 경우 **10000초**가 걸리는 반면에, 멀티 쓰레드를 사용하였을 경우 CPU에 코어가 10개가 있어서 각 쓰레드들이 **동시에 실행**된다면, 각 쓰레드의 덧셈은 1000초가 걸리고, 마지막으로 합치는 10초를 포함하여 총 **1010초**가 걸리게 된다.

이는 10배의 차이를 보인다.

이렇게 어떠한 작업을 여러 개의 다른 쓰레드를 이용해서 좀 더 빠르게 수행하는 것을 **병렬화(Parallelize)**라고 한다.



#### 병렬화가 불가능한 작업

병렬화가 불가능한 작업들도 있는데, 대표적인 예로 피보나치 수열 계산이 있다.

피보나치 수열 계산은 **연산A를 수행하기 위해 다른 연산B의 결과가 필요**하기 때문이다.

이와 같은 상황을 **A가 B에 의존(Dependent)**이라고 한다.

> 프로그램 논리 구조 상에서 연산들간의 의존 관계가 많을 수록 병렬화가 어려워지고, 다른 연산의 결과와 관계없이 독립적으로 수행할 수 있는 구조가 많을 수록 병렬화가 쉬워진다.



### 대기 시간이 긴 작업들

인터넷에서 웹사이트들을 긁어 모으는 프로그램을 구현해본다고 가정한다.

```cpp
int main()
{
    // 다운 받으려는 웹사이트와 내용을 저장하는 맵
    map<string, string> url_and_content;
    for (auto itr = url_and_content.begin(); itr != url_and_content.end(); ++itr)
    {
        const string& url = itr->first;
        
        // download 함수는 인자로 전달받은 url에 있는 사이트를 다운 받아 리턴한다.
        itr->second = download(url);
    }
}
```

`ping`은 내가 보낸 요청이 상대 서버에 도착해서 다시 나에게 돌아오는데 걸리는 시간을 의미한다. 보통 우리나라 안에서 웹사이트에 요청을 보낼 시에 `ping`이 30밀리초 정도이고, 해외의 경우 150에서 300까지 걸리게 되는데, 이 시간만큼 CPU를 기다리게 하는 것은 CPU 코어를 **비효율적**으로 사용하게 된다.

![multithread_web](https://user-images.githubusercontent.com/57252713/174428841-e59de7da-a1f0-4e13-90e9-feed0bacef55.png)

위 그림은 **컨텍스트 스위칭**을 통해서 기다리는 시간 없이 CPU를 최대한으로 사용하는 것을 보여준다.



다음 시간에는 C++로 쓰레드를 생성하는 방법에 대해 소개해보도록 하겠다. ^^v



#### 참고

> 모두의 코드, <https://modoocode.com/269>
>

